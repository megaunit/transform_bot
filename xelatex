#!/usr/bin/env python
import sys
import subprocess
import os

# Wrapper to make tectonic look like xelatex to Manim
# Arguments passed by manim:
# xelatex [-no-pdf] -interaction=batchmode -halt-on-error -output-directory=PWD/media/Tex/... PWD/media/Tex/.../hash.tex

tectonic_cmd = ["tectonic"]
input_file = None
out_dir = None
out_fmt = "pdf" # default

for arg in sys.argv[1:]:
    if arg == "-no-pdf":
        out_fmt = "xdv"
    elif arg.startswith("-output-directory="):
        out_dir = arg.split("=", 1)[1]
    elif arg.startswith("-interaction="):
        pass # Ignore
    elif arg == "-halt-on-error":
        pass # Ignore
    elif arg.startswith("-"):
        # Ignore other flags
        pass 
    else:
        input_file = arg

if out_fmt:
    tectonic_cmd.extend(["--outfmt", out_fmt])
if out_dir:
    tectonic_cmd.extend(["--outdir", out_dir])

if input_file:
    tectonic_cmd.append(input_file)
else:
    print("Error: No input file provided to xelatex wrapper")
    sys.exit(1)

# Execute tectonic
try:
    subprocess.run(tectonic_cmd, check=True)
except subprocess.CalledProcessError as e:
    sys.exit(e.returncode)
except FileNotFoundError:
    print("Error: tectonic command not found in PATH")
    sys.exit(127)
